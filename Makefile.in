# The top-level Makefile that is used to build 

SUBDIRS := 3rdparty/cpp \
           rt/cpp \
           util/cpp \
           io/cpp \
           logging/cpp \
           modest/cpp \
           event/cpp \
           config/cpp \
           crypto/cpp \
           compress/cpp \
           data/cpp \
           net/cpp \
           mail/cpp \
           sphinx/cpp \
           sql/cpp \
           validation/cpp \
           test/cpp

ifndef PRINT_DIRECTORIES
PRINT_DIRECTORIES_OPTS = --no-print-directory -s
endif
ifdef PRINT_COMMANDS
PRINT_COMMANDS_OPTS = PRINT_COMMANDS=$(PRINT_COMMANDS)
endif

MAKE_CMD = $(PRINT_COMMANDS_OPTS) $(MAKE) -j -l 5.0 $(PRINT_DIRECTORIES_OPTS)
MAKE_DIR = $(PRINT_COMMANDS_OPTS) $(MAKE_CMD) -C $(dir)

.PHONY: all verbose clean test internal-docs

all:
	@$(foreach dir,$(SUBDIRS),$(MAKE_DIR) build-objects build-libraries &&) true
	@$(foreach dir,$(SUBDIRS),$(MAKE_DIR) build-executables &&) true

clean:
	@$(foreach dir,$(SUBDIRS),MAKE_CLEAN_ACTIVE=true $(MAKE_DIR) clean &&) true
	@rm -rf libs/*
	@echo "Cleaned all objects and libraries."

test: all
	LD_LIBRARY_PATH=@DBCOREDIR@/libs/linux test/cpp/dist/linux/run-unit-tests

internal-docs:
	rm -rf docs/cpp-api
	mkdir -p docs/cpp-api
	doxygen setup/docs.doxygen

verbose:
	PRINT_DIRECTORIES=true $(MAKE) all

verbose-commands:
	PRINT_DIRECTORIES=true PRINT_COMMANDS=true $(MAKE) all

valgrind:
	./dbcore-valgrind test/cpp/dist/linux/run-unit-tests
