# This file contains basic Makefile includes that contain all 
# common building instructions for all binaries and packages.

.PHONY: all build-setup build-clean build-directories build-headers build-objects build-libraries build-executables clean clean-objects clean-libraries

all: build-objects build-libraries build-executables

PLATFORM=@PLATFORM@
BUILD_FOR_LINUX=@BUILD_FOR_LINUX@
BUILD_FOR_WINDOWS=@BUILD_FOR_WINDOWS@
BUILD_FOR_MACOS=@BUILD_FOR_MACOS@

AR_FLAGS = cr

MONARCH = $(realpath @MONARCH_DIR@)
TOP_SRC_DIR = $(MONARCH)
TOP_BUILD_DIR = $(MONARCH)

INCLUDES += -I$(TOP_BUILD_DIR)/dist/include 

CWD = $(shell pwd)
ifndef HEADER_DIST_DIR
HEADER_DIST_DIR = dist/include/monarch/$(notdir $(CWD))
endif

# Build rules common to each platform
ifdef PRINT_COMMANDS
PCMD=
else
PCMD=@
endif

.SECONDEXPANSION:

# Variables for all platforms

CXX ?= @CXX@
MO_CXX_FLAGS += @CXXFLAGS@ @DEFS@ -Wall
MO_LD_FLAGS += @LDFLAGS@
MO_INCLUDES += $(INCLUDES)
MO_LIBS += -L$(MO_LIB_DIR)
AR ?= @AR@
AS ?= @AS@

# Platform-specific variables

ifeq ($(BUILD_FOR_LINUX),yes)
PLATFORM_NAME=LINUX
LIB_PREFIX=lib
DYNAMIC_LIB_EXT=so
STATIC_LIB_EXT=a
EXECUTABLE_EXT=
MO_CXX_FLAGS += -march=i686 -fPIC -DLINUX $(MODULE_CXX_FLAGS) $(MODULE_LINUX_CXX_FLAGS)
MO_LIBS += -L/usr/lib/mysql
endif

ifeq ($(BUILD_FOR_MACOS),yes)
PLATFORM_NAME=MACOS
LIB_PREFIX=lib
DYNAMIC_LIB_EXT=dylib
STATIC_LIB_EXT=a
EXECUTABLE_EXT=
# TODO: support build target config and use -march=i686/powerpc/etc
MO_CXX_FLAGS += -fPIC -DMACOS $(MODULE_CXX_FLAGS) $(MODULE_MACOS_CXX_FLAGS)
MO_LD_FLAGS += -Wl,-flat_namespace
MO_LIB_LD_FLAGS += \
	-Wl,-dylib_compatibility_version,@FULL_DOTTED_VERSION@ \
	-Wl,-dylib_current_version,@FULL_DOTTED_VERSION@
# Add default location for Fink
MO_INCLUDES += -I/sw/include 
MO_LIBS += -L/sw/lib
endif

ifeq ($(BUILD_FOR_WINDOWS),yes)
PLATFORM_NAME=WINDOWS
LIB_PREFIX=
DYNAMIC_LIB_EXT=dll
STATIC_LIB_EXT=lib
EXECUTABLE_EXT=.exe
MO_CXX_FLAGS += -march=i686 -D_WIN32_WINNT=0x0501 $(MODULE_CXX_FLAGS)
MO_LD_FLAGS += -Wl,--enable-auto-import
MO_INCLUDES += \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/pthread/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/openssl/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/expat/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/mysql/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/regex/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/sqlite3/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/zlib/include \
	-I$(TOP_SRC_DIR)/cpp/3rdparty/iconv/include
endif

# Platform-agnostic build rules 

include $(TOP_SRC_DIR)/setup/monarch.mk

build-setup:

build-clean:

$(ALL_DIRECTORIES):
	mkdir -p $@

clean: build-clean clean-libraries clean-objects

build-headers: $(ALL_HEADERS)

build-objects: $(ALL_DIRECTORIES) $(ALL_SOURCES) $(ALL_OBJECTS)

build-libraries: $(ALL_DIRECTORIES) $(ALL_LIBRARIES)

build-executables: $(ALL_DIRECTORIES) $(ALL_EXECUTABLES)
