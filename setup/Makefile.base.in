# This file contains basic Makefile includes that contain all building
# instructions for all binaries and packages.

AR_FLAGS = cr
CXX_FLAGS = -g -Wall -fPIC
INCLUDES = -I@DBCOREDIR@/config/cpp -I@DBCOREDIR@/crypto/cpp -I@DBCOREDIR@/data/cpp -I@DBCOREDIR@/event/cpp -I@DBCOREDIR@/io/cpp -I@DBCOREDIR@/mail/cpp -I@DBCOREDIR@/modest/cpp -I@DBCOREDIR@/net/cpp -I@DBCOREDIR@/rt/cpp -I@DBCOREDIR@/sql/cpp -I@DBCOREDIR@/test/cpp -I@DBCOREDIR@/util/cpp

MODULE_BASE_DIR = $(shell pwd)

.PHONY: all build-directories build-objects build-libraries build-executables clean clean-objects clean-libraries

all: build-directories build-objects build-libraries build-executables
   @echo "SOURCES: $(SOURCES)"

LINUX_BUILD_DIR = build/linux
LINUX_DIST_DIR = dist/linux
LINUX_SOURCES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.cpp, $(SOURCES))
LINUX_SOURCES += $(patsubst %,$(LINUX_BUILD_DIR)/%.cpp, $(EXECUTABLES))
LINUX_OBJECTS := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.o, $(SOURCES))
LINUX_OBJECTS += $(patsubst %,$(LINUX_BUILD_DIR)/%.o, $(EXECUTABLES))
LINUX_EXECUTABLES := $(patsubst %,$(LINUX_DIST_DIR)/%, $(EXECUTABLES))
LINUX_DEPENDENCIES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.P, $(SOURCES))

LINUX_LIBRARIES := $(patsubst %,$(LINUX_DIST_DIR)/lib%.so, $(LIBRARIES))
LINUX_LIBRARIES += $(patsubst %,$(LINUX_DIST_DIR)/lib%.a, $(LIBRARIES))

-include $(LINUX_DEPENDENCIES)

%.cpp:
	@mkdir -p $(dir $@)
	@ln -sf $(subst $(LINUX_BUILD_DIR)/,$(MODULE_BASE_DIR)/,$@) $@

%.o: %.cpp
	@echo "Building $@..."
	@$(CXX) $(CXX_FLAGS) -c -MD -o $@ $(INCLUDES) -I. $<
	@cp $*.d $*.P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.d >> $*.P; \
		rm -f $*.d

%.so: $(LINUX_OBJECTS)
	@echo "Building $@..."
	@$(CXX) -shared -o $@ $(LINUX_OBJECTS)

%.a: $(LINUX_OBJECTS)
	@echo "Building $@..."
	@$(AR) $(AR_FLAGS) $@ $(LINUX_OBJECTS)

%.P: %.cpp
	@$(CXX) -E -MD -o $@ $(INCLUDES) -I. $<
	@cp $*.d $*.P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.d >> $*.P; \
		rm -f $*.d

ifdef EXECUTABLES
$(LINUX_EXECUTABLES): 
	@echo "$(LINUX_BUILD_DIR)/$(@F).o"
	$(CXX) $(CXX_FLAGS) -o $@ $(LINUX_BUILD_DIR)/$(@F).o $(STATIC_LINK_LIBRARIES) $(DYNAMIC_LINK_LIBRARIES:%=-l%)
endif

build-directories:
	@mkdir -p $(LINUX_BUILD_DIR)
	@mkdir -p $(LINUX_DIST_DIR)

build-objects: $(LINUX_SOURCES) $(LINUX_OBJECTS)
	@echo "Completed building objects..."

build-libraries: $(LINUX_LIBRARIES)
	@echo "Completed building libraries..."

build-executables: $(LINUX_EXECUTABLES)
	@echo "Completed building executables..."

clean: clean-libraries clean-objects

clean-objects:
	@echo "Removing all objects..."
	@rm -rf $(LINUX_BUILD_DIR)

clean-libraries:
	@echo "Removing all libraries..."
	@rm -rf $(LINUX_DIST_DIR)
