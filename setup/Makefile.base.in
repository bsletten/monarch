# This file contains basic Makefile includes that contain all building
# instructions for all binaries and packages.

AR_FLAGS = cr
CXX_FLAGS = -g -Wall -fPIC
DBCORE = @DBCOREDIR@
INCLUDES = -I$(DBCORE)/config/cpp -I$(DBCORE)/crypto/cpp -I$(DBCORE)/data/cpp -I$(DBCORE)/event/cpp -I$(DBCORE)/io/cpp -I$(DBCORE)/mail/cpp -I$(DBCORE)/modest/cpp -I$(DBCORE)/net/cpp -I$(DBCORE)/rt/cpp -I$(DBCORE)/sql/cpp -I$(DBCORE)/test/cpp -I$(DBCORE)/util/cpp
LIBS = $(DBCORE)/libs

MODULE_BASE_DIR = $(shell pwd)

.PHONY: all build-directories build-objects build-libraries build-executables clean clean-objects clean-libraries $(LINUX_EXECUTABLES)

all: build-directories build-objects build-libraries build-executables
   @echo "SOURCES: $(SOURCES)"

LINUX_BUILD_DIR = build/linux
LINUX_DIST_DIR = dist/linux
LINUX_SOURCES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.cpp, $(SOURCES))
LINUX_SOURCES += $(patsubst %,$(LINUX_BUILD_DIR)/%.cpp, $(EXECUTABLES))
LINUX_OBJECTS := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.o, $(SOURCES))
LINUX_OBJECTS += $(patsubst %,$(LINUX_BUILD_DIR)/%.o, $(EXECUTABLES))
LINUX_EXECUTABLES := $(patsubst %,$(LINUX_DIST_DIR)/%, $(EXECUTABLES))
LINUX_DEPENDENCIES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.P, $(SOURCES))

LINUX_LIBRARIES := $(patsubst %,$(LINUX_DIST_DIR)/lib%.so, $(LIBRARIES))
LINUX_LIBRARIES += $(patsubst %,$(LINUX_DIST_DIR)/lib%.a, $(LIBRARIES))

-include $(LINUX_DEPENDENCIES)

%.cpp:
	@mkdir -p $(dir $@)
	@ln -sf $(subst $(LINUX_BUILD_DIR)/,$(MODULE_BASE_DIR)/,$@) $@

%.o: %.cpp
	@echo "Building $@..."
	@$(CXX) $(CXX_FLAGS) -c -MD -o $@ $(INCLUDES) -I. $<
	@cp $*.d $*.P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.d >> $*.P; \
		rm -f $*.d

%.so: $(LINUX_OBJECTS)
	@echo "Building $@..."
	@$(CXX) -L$(LIBS)/linux -shared -o $@ $(LINUX_OBJECTS) $(DYNAMIC_LINK_LIBRARIES:%=-l%) 
	@mkdir -p $(LIBS)/linux
	@ln -sf $(MODULE_BASE_DIR)/$@ $(DBCORE)/libs/linux/$(@F)

%.a: $(LINUX_OBJECTS)
	@echo "Building $@..."
	@$(AR) $(AR_FLAGS) $@ $(LINUX_OBJECTS)
	@mkdir -p $(DBCORE)/libs/linux
	@ln -sf $(MODULE_BASE_DIR)/$@ $(DBCORE)/libs/linux/$(@F)

%.P: %.cpp
	@$(CXX) -E -MD -o $@ $(INCLUDES) -I. $<
	@cp $*.d $*.P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.d >> $*.P; \
		rm -f $*.d

ifdef EXECUTABLES
$(LINUX_EXECUTABLES): $(LINUX_EXECUTABLES:%=%.cpp)
	@echo "Building $@..."
	@$(CXX) $(CXX_FLAGS) -o $@ $(LINUX_BUILD_DIR)/$(@F).o $(STATIC_LINK_LIBRARIES) $(DYNAMIC_LINK_LIBRARIES:%=-l%)
endif

build-directories:
	@mkdir -p $(LINUX_BUILD_DIR)
	@mkdir -p $(LINUX_DIST_DIR)

build-objects: $(LINUX_SOURCES) $(LINUX_OBJECTS)

build-libraries: $(LINUX_LIBRARIES)

build-executables: $(LINUX_EXECUTABLES)

clean: clean-libraries clean-objects

clean-objects:
	@echo "Removing all objects..."
	@rm -rf $(LINUX_BUILD_DIR)

clean-libraries:
	@echo "Removing all libraries and executables..."
	@rm -rf $(LINUX_DIST_DIR)
